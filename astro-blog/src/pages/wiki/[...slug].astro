---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const wikiEntries = await getCollection("wiki");

  // Create paths for both individual pages and directory indexes
  const paths = [];

  wikiEntries.forEach((entry) => {
    // Remove .md extension first
    const slug = entry.id.replace(/\.md$/, "");

    if (entry.id.endsWith("/index.md") || entry.id === "index.md") {
      // Directory index - add trailing slash
      // Remove the trailing /index part for directory indexes, or handle root index
      const dirPath = slug === "index" ? "" : slug.replace(/\/index$/, "");
      paths.push({
        params: { slug: dirPath || undefined },
        props: { entry, isIndex: true },
      });
    } else {
      // Individual page - no trailing slash
      paths.push({
        params: { slug },
        props: { entry, isIndex: false },
      });
    }
  });

  return paths;
}

const { entry, isIndex } = Astro.props;
const { Content } = await entry.render();

// GitHub edit URL
const githubEditUrl = `https://github.com/jadeforrest/blog/edit/master/content/wiki/${entry.id}`;

// Get all wiki entries for directory listing
const allWikiEntries = isIndex ? await getCollection("wiki") : [];
const currentDir = entry.id.replace(/\/index\.md$/, "").replace(/^index\.md$/, "");

// Filter entries in current directory
const entriesInDir = isIndex
  ? allWikiEntries
      .filter((e) => {
        // Always exclude the current entry
        if (e.id === entry.id) return false;

        if (currentDir === "") {
          // Root index - show top-level items only
          return !e.id.includes("/") || e.id.match(/^[^/]+\/index\.md$/);
        } else {
          // Subdirectory index - show items in this directory
          const prefix = currentDir + "/";
          return (
            e.id.startsWith(prefix) &&
            (e.id.slice(prefix.length).split("/").length === 1 ||
              e.id.slice(prefix.length).match(/^[^/]+\/index\.md$/))
          );
        }
      })
      .sort((a, b) => a.data.title.localeCompare(b.data.title))
  : [];
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
  <article class="wiki-page" data-pagefind-body>
    <header class="wiki-header">
      <div class="wiki-edit-link-container">
        <a
          href={githubEditUrl}
          class="wiki-edit-link"
          target="_blank"
          rel="noopener noreferrer"
        >
          Edit this page on github
        </a>
      </div>
      <h1 data-pagefind-meta="title">
        {entry.data.icon && <span class="wiki-icon">{entry.data.icon}</span>}
        {entry.data.title}
      </h1>
      {entry.data.description && (
        <p class="wiki-description">{entry.data.description}</p>
      )}
    </header>

    <div class="wiki-content">
      <Content />
    </div>

    {
      isIndex && entriesInDir.length > 0 && (
        <div class="wiki-listing">
          <h2>Pages in this section</h2>
          <ul>
            {entriesInDir.map((e) => {
              const isSubdir = e.id.endsWith("/index.md");
              // Remove .md first, then remove /index for subdirectories
              let linkSlug = e.id.replace(/\.md$/, "");
              if (isSubdir) {
                linkSlug = linkSlug.replace(/\/index$/, "");
              }
              const linkPath = isSubdir ? `/${linkSlug}/` : `/${linkSlug}`;

              return (
                <li>
                  <a href={`/wiki${linkPath}`}>
                    {e.data.icon && <span class="wiki-icon">{e.data.icon}</span>}
                    {e.data.title}
                  </a>
                  {e.data.description && (
                    <span class="entry-description">- {e.data.description}</span>
                  )}
                </li>
              );
            })}
          </ul>
        </div>
      )
    }
  </article>
</BaseLayout>

<style>
  .wiki-page {
    max-width: var(--size-article-max-width);
    margin: 0 auto;
  }

  .wiki-header {
    margin-bottom: var(--space-l);
  }

  .wiki-edit-link-container {
    margin-bottom: var(--space-s);
  }

  .wiki-edit-link {
    font-size: 0.9em;
    color: #666;
    text-decoration: none;
    border: 1px solid #ddd;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
  }

  .wiki-edit-link:hover {
    background-color: var(--background-color-alt);
    border-color: #bbb;
  }

  .wiki-header h1 {
    font-size: var(--heading-size-h1);
    line-height: var(--heading-line-height-h1);
    color: var(--text-color-primary);
    margin-bottom: var(--space-s);
  }

  .wiki-icon {
    margin-right: var(--space-xs);
  }

  .wiki-description {
    font-size: var(--font-size-m);
    color: var(--color-neutral-gray-j);
    font-style: italic;
  }

  .wiki-content {
    line-height: var(--text-line-height-default);
    font-size: var(--font-size-s);
  }

  .wiki-content :global(h2) {
    font-size: var(--heading-size-h2);
    line-height: var(--heading-line-height-h2);
    margin: var(--space-l) 0 var(--space-m);
    font-weight: var(--font-weight-bold);
    color: var(--text-color-primary);
  }

  .wiki-content :global(h3) {
    font-size: var(--heading-size-h3);
    line-height: var(--heading-line-height-h3);
    margin: var(--space-m) 0 var(--space-s);
    font-weight: var(--font-weight-bold);
    color: var(--text-color-primary);
  }

  .wiki-content :global(p) {
    margin: 0 0 var(--space-m);
  }

  .wiki-content :global(ul),
  .wiki-content :global(ol) {
    margin: 0 0 var(--space-m);
    padding-left: var(--space-l);
  }

  .wiki-content :global(li) {
    margin-bottom: var(--space-xs);
  }

  .wiki-content :global(a) {
    color: var(--color-brand-primary);
    text-decoration: underline;
  }

  .wiki-content :global(a:hover) {
    color: var(--color-brand-hover);
  }

  .wiki-listing {
    margin-top: var(--space-xl);
    padding-top: var(--space-l);
    border-top: 2px solid var(--color-neutral-gray-c);
  }

  .wiki-listing h2 {
    font-size: var(--heading-size-h2);
    line-height: var(--heading-line-height-h2);
    margin-bottom: var(--space-m);
    color: var(--text-color-primary);
  }

  .wiki-listing ul {
    list-style: none;
    padding: 0;
  }

  .wiki-listing li {
    margin-bottom: var(--space-s);
    padding: var(--space-s);
    background: var(--background-color-alt);
    border-radius: var(--size-radius-small);
  }

  .wiki-listing a {
    color: var(--color-brand-primary);
    text-decoration: none;
    font-weight: var(--font-weight-bold);
  }

  .wiki-listing a:hover {
    color: var(--color-brand-hover);
    text-decoration: underline;
  }

  .entry-description {
    color: var(--color-neutral-gray-j);
    font-size: var(--font-size-xs);
    margin-left: var(--space-xs);
  }
</style>
