---
import BaseLayout from "../layouts/BaseLayout.astro";
import Parser from "rss-parser";
import { FaCalendar } from "react-icons/fa";
import { formatDate } from "../utils/formatDate";

// Fetch podcast episodes at build time
const RSS_URL = "https://anchor.fm/s/f420aba8/podcast/rss";
const MAX_EPISODES = 5;

const parser = new Parser({
  customFields: {
    item: [["content:encoded", "contentEncoded"]],
  },
});

let episodes: any[] = [];
try {
  const feed = await parser.parseURL(RSS_URL);
  episodes = (feed.items || []).slice(0, MAX_EPISODES);
} catch (error) {
  console.error("Error fetching podcast feed:", error);
}

function stripHtml(value: string): string {
  return value.replace(/<[^>]*>/g, " ");
}

function normalizeWhitespace(value: string): string {
  return value.trim().replace(/\s+/g, " ");
}
---

<BaseLayout
  title="Decoding Leadership Podcast | Jade Rubick"
  description="Where we break down the elements of humane and effective leadership"
>
  <div class="podcast-page">
    <div class="podcast-intro">
      <div class="intro-logo">
        <img
          src="/images/decoding-leadership-6.png"
          alt="Decoding Leadership Podcast"
          class="podcast-logo"
        />
      </div>
      <div class="intro-text">
        <p>
          <a
            href="https://podcasters.spotify.com/pod/show/decodingleadership"
            target="_blank"
            rel="noopener noreferrer"
            class="listen-link"
          >
            Listen to Decoding Leadership
          </a>
        </p>
        <p>Where we break down the elements of humane and effective leadership.</p>
      </div>
    </div>

    <div class="testimonial">
      <blockquote>
        "This is hands down one of the best podcast discussions on incident
        management, coordination, and reliability I've seen in ages!
        Fantastic conversation between Beth Adele Long and Jade Rubick on the
        Decoding Leadership podcast. Definitely worth a listen for anyone
        working in this space."
      </blockquote>
      <p class="attribution">
        â€” <a
          href="https://www.resiliumlabs.com"
          target="_blank"
          rel="noopener noreferrer">Adrian Hornsby</a
        >
        <a
          href="https://www.linkedin.com/posts/adhorn_beth-adele-long-on-reliability-and-leadership-activity-7366471477837127682-ZXfV?rcm=ACoAAABlKc0BaeEYgJ_9P6NkNW6WS3BVMP2QmzA"
          target="_blank"
          rel="noopener noreferrer">on LinkedIn</a
        >
      </p>
    </div>

    <section class="latest-episodes">
      <h2>Latest Episodes</h2>
      <div class="episode-grid">
        {
          episodes.map((episode) => {
            const title = episode.title || "Untitled episode";
            const link = episode.link || "#";
            const isoDate =
              episode.isoDate || episode.pubDate || new Date().toISOString();
            const formattedDate = formatDate(isoDate);
            const descriptionSource =
              episode.contentSnippet ||
              episode.content ||
              episode.contentEncoded ||
              "";
            const description = normalizeWhitespace(
              stripHtml(descriptionSource)
            );

            return (
              <article class="episode-card">
                <h3>{title}</h3>
                <p class="episode-meta">
                  <FaCalendar size={14} /> {formattedDate}
                </p>
                <p>{description}</p>
                <a
                  href={link}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="listen-button"
                >
                  Listen now
                </a>
              </article>
            );
          })
        }
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .podcast-page {
    max-width: 1200px;
    margin: 0 auto;
  }

  .podcast-intro {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 3rem;
    align-items: start;
    margin-bottom: var(--space-l);
  }

  .intro-logo {
    display: flex;
    justify-content: center;
  }

  .podcast-logo {
    width: 100%;
    max-width: 300px;
    border-radius: var(--size-radius-default);
  }

  .intro-text {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .intro-text p {
    font-size: var(--font-size-m);
    line-height: var(--text-line-height-default);
    margin-bottom: var(--space-m);
  }

  .listen-link {
    color: var(--color-brand-primary);
    font-weight: var(--font-weight-bold);
    text-decoration: none;
    font-size: var(--font-size-l);
  }

  .listen-link:hover {
    color: var(--color-brand-hover);
    text-decoration: underline;
  }

  .testimonial {
    width: 100%;
    margin-bottom: var(--space-xl);
  }

  .testimonial blockquote {
    font-style: italic;
    margin: 0;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    line-height: var(--text-line-height-default);
  }

  .attribution {
    text-align: right;
    margin-top: 1rem;
    font-size: var(--font-size-s);
  }

  .attribution a {
    color: var(--color-brand-primary);
    text-decoration: none;
  }

  .attribution a:hover {
    color: var(--color-brand-hover);
    text-decoration: underline;
  }

  .latest-episodes h2 {
    font-size: var(--heading-size-h2);
    line-height: var(--heading-line-height-h2);
    margin-top: 0;
    margin-bottom: var(--space-l);
    color: var(--text-color-primary);
  }

  .episode-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-s);
    margin: 2rem 0;
  }

  .episode-card {
    display: flex;
    flex-direction: column;
    border-radius: var(--size-radius-default);
    overflow: hidden;
    background: var(--color-neutral-white);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    transition: all var(--time-duration-default);
    margin-bottom: var(--space-s);
    padding: var(--space-m);
  }

  .episode-card:hover {
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
  }

  .episode-card h3 {
    font-size: var(--heading-size-h3);
    line-height: var(--heading-line-height-h3);
    margin: 0 0 var(--space-xs) 0;
    color: var(--text-color-primary);
  }

  .episode-meta {
    font-size: var(--font-size-xs);
    color: var(--color-neutral-gray-j);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin: 0 0 var(--space-s) 0;
  }

  .episode-meta :global(svg) {
    color: var(--color-brand-primary);
  }

  .episode-card p {
    margin: 0 0 var(--space-s) 0;
    color: var(--color-neutral-gray-j);
    line-height: 1.6;
    font-size: var(--font-size-s);
  }

  .listen-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: var(--space-xs) var(--space-m);
    border-radius: var(--size-radius-small);
    background: var(--color-brand-primary);
    color: var(--color-neutral-white);
    text-decoration: none;
    font-weight: 600;
    transition: background 0.2s ease;
    font-size: var(--font-size-s);
    align-self: flex-start;
  }

  .listen-button:hover {
    background: var(--color-brand-hover);
  }

  @media (max-width: 768px) {
    .podcast-intro {
      grid-template-columns: 1fr;
      gap: var(--space-m);
    }

    .intro-logo {
      justify-content: flex-start;
    }

    .podcast-logo {
      max-width: 250px;
    }
  }

  @media (min-width: 600px) {
    .episode-card {
      margin-bottom: var(--space-m);
    }
  }
</style>
